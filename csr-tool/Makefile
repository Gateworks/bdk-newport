# ***********************license start***********************************
# Copyright (c) 2003-2017  Cavium Inc. (support@cavium.com). All rights
# reserved.
#
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#
#   * Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#
#   * Redistributions in binary form must reproduce the above
#     copyright notice, this list of conditions and the following
#     disclaimer in the documentation and/or other materials provided
#     with the distribution.
#
#   * Neither the name of Cavium Inc. nor the names of
#     its contributors may be used to endorse or promote products
#     derived from this software without specific prior written
#     permission.
#
# This Software, including technical data, may be subject to U.S. export
# control laws, including the U.S. Export Administration Act and its
# associated regulations, and may be subject to export or import
# regulations in other countries.
#
# TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"
# AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR
# WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT
# TO THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY
# REPRESENTATION OR DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT
# DEFECTS, AND CAVIUM SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES
# OF TITLE, MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR
# PURPOSE, LACK OF VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT,
# QUIET POSSESSION OR CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK
# ARISING OUT OF USE OR PERFORMANCE OF THE SOFTWARE LIES WITH YOU.
# **********************license end**************************************

SVNROOT=svn+ssh://kreesema@masvn/svn

.NOTPARALLEL:
.PHONY: help
.DEFAULT: help
.SILENT: help
help:
	echo ""
	echo "Tool to generate files from YAML CSR files"
	echo ""
	echo "Targets:"
	echo "    fetch:        Fetch YAML from tiger01:work/csr/*.yaml"
	echo "    generate:     Read in the YAML and generate all output files"
	echo "    copy-html:    Copy html files to /var/www/csr-html"
	echo "    copy-headers: Copy all generated files into their correct locations"
	echo "    copy: Do both copy-html and copy-headers"
	echo "    all:          Do fetch, generate, and copy"
	echo "    clean:        Clean generated and downloaded files"
	echo ""
	echo "Note:"
	echo "  * The YAML files fetched are generated by Makefile.csr-cluster"
	echo "    run on the MA cluster (tiger01). This uses csr3 to simplify"
	echo "    the YAML before this file uses it."
	echo "  * All CSRs in a chip are in one big YAML file."
	echo "  * YAML files are named by chip and pass. See the yaml dir after fetch."
	echo "  * chip_list.py has all the chip and pass info."
	echo ""

.PHONY: all
all: fetch generate copy

.PHONY: fetch
fetch: clean
	rm -rf yaml
	mkdir yaml
	scp -C tiger01:work/csr/*.yaml yaml/
	# Fixups for CN70XX
	sed -i "s/SMI\\([0-9(]\\)/SMI_\\1/g" yaml/o70*.yaml
	# Fixups for CN73XX
	sed -i "s/CIU3_/CIU_/g" yaml/o73*.yaml
	# Fixups for CNF75XX
	sed -i "s/CIU3_/CIU_/g" yaml/o75*.yaml
	# Fixups for CN78XX
	sed -i "s/CIU3_/CIU_/g" yaml/o78*.yaml
	# Fixups for CN93XX
	# The hardware team removed the PEM index from the PCIe config
	# registers. The BDK needs this to determine which PEM you are
	# accessing.
	sed -i "s/name: PCIEEP_/name: PCIEEP(0..3)_/g" yaml/t93*.yaml
	sed -i "s/name: PCIEEPVF_/name: PCIEEPVF(0..3)_/g" yaml/t93*.yaml
	sed -i "s/name: PCIERC_/name: PCIERC(0..3)_/g" yaml/t93*.yaml

.PHONY: generate
generate:
	rm -rf html output
	mkdir html output output/octeon output/thunder output/thunder2
	cp sorttable.js html/
	cp csr.css html/
	./csr-tool.py

.PHONY: copy-headers
copy-headers:
	rm -f mv ../libbdk-arch/bdk-csrs*.h
	mv output/thunder/bdk-csrs*.h ../libbdk-arch/
	mv output/thunder/bdk-csrs.c ../libbdk-arch/

.PHONY: copy-html
copy-html:
	rm -rf /var/www/html/csr-html
	mv html /var/www/html/csr-html
	chmod -R o+r /var/www/html/csr-html

.PHONY: copy
copy: copy-headers copy-html

.PHONY: clean
clean:
	rm -rf output html yaml *.pickle *.pyc

